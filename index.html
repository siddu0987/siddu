<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Decentralized Resume Verification</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #e5f0ff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 30px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    h2 {
      color: #1e3a8a;
      margin-bottom: 20px;
      font-size: 24px;
    }
    input[type="file"] {
      margin: 10px 0;
      width: 100%;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 14px;
    }
    button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    #connectWalletBtn {
      background-color: #2563eb;
    }
    #verifyBtn {
      background-color: #16a34a;
      display: none;
    }
    .status {
      margin-top: 15px;
      padding: 12px;
      border-radius: 6px;
      font-weight: 500;
      font-size: 14px;
    }
    .connected {
      background-color: #d1fae5;
      color: #065f46;
    }
    .not-connected {
      background-color: #f3f4f6;
      color: #6b7280;
    }
    .not-verified {
      background-color: #fee2e2;
      color: #991b1b;
    }
    .verified {
      background-color: #dcfce7;
      color: #166534;
    }
    .error {
      background-color: #fee2e2;
      color: #991b1b;
    }
    .warning {
      background-color: #fef3c7;
      color: #92400e;
    }
    .small-text {
      color: #6b7280;
      font-size: 13px;
      margin-top: 5px;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f9fafb;
      border-radius: 8px;
    }
    .section h3 {
      margin: 0 0 10px 0;
      color: #374151;
      font-size: 16px;
    }
    label {
      display: block;
      text-align: left;
      margin: 10px 0 5px 0;
      color: #374151;
      font-weight: 500;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Decentralized Resume Verification</h2>

    <div class="section">
      <h3>Setup Contract</h3>
      <label for="contractAddress">Contract Address</label>
      <input type="text" id="contractAddress" placeholder="0xd9145CCE52D386f254917e481eB44e9943F39138" />
      <button id="saveContractBtn" style="background-color: #7c3aed;">Save Contract</button>
      <div id="contractStatus" class="status small-text not-connected">Contract not configured</div>
    </div>

    <div class="section">
      <h3>Wallet Connection</h3>
      <button id="connectWalletBtn">Connect MetaMask</button>
      <div id="walletStatus" class="status not-connected">Not connected</div>
    </div>

    <div class="section">
      <h3>Resume Upload</h3>
      <label for="resumeFile">Upload Resume PDF</label>
      <input type="file" id="resumeFile" accept=".pdf" />
      <div class="small-text">File selected: <span id="fileName">None</span></div>
    </div>

    <div class="section">
      <h3>Verification</h3>
      <div id="verificationStatus" class="status not-verified">
        ‚ùå Not Verified
      </div>
      <button id="verifyBtn">‚úÖ Verify Resume (Admin Only)</button>
    </div>
  </div>

  <script>
    const ABI = [
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "resumeId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			}
		],
		"name": "ResumeSubmitted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "resumeId",
				"type": "uint256"
			}
		],
		"name": "ResumeVerified",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_email",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_qualification",
				"type": "string"
			},
			{
				"internalType": "string[]",
				"name": "_skills",
				"type": "string[]"
			},
			{
				"internalType": "string",
				"name": "_experience",
				"type": "string"
			}
		],
		"name": "submitResume",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"stateMutability": "payable",
		"type": "fallback"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_resumeId",
				"type": "uint256"
			}
		],
		"name": "verifyResume",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"stateMutability": "payable",
		"type": "receive"
	},
	{
		"inputs": [],
		"name": "admin",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getMyResumeIds",
		"outputs": [
			{
				"internalType": "uint256[]",
				"name": "",
				"type": "uint256[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_resumeId",
				"type": "uint256"
			}
		],
		"name": "getResume",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "email",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "qualification",
				"type": "string"
			},
			{
				"internalType": "string[]",
				"name": "skills",
				"type": "string[]"
			},
			{
				"internalType": "string",
				"name": "experience",
				"type": "string"
			},
			{
				"internalType": "bool",
				"name": "verified",
				"type": "bool"
			},
			{
				"internalType": "address",
				"name": "submittedBy",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "resumeCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "resumes",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "email",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "qualification",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "experience",
				"type": "string"
			},
			{
				"internalType": "bool",
				"name": "verified",
				"type": "bool"
			},
			{
				"internalType": "address",
				"name": "submittedBy",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "resumesByUser",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

    let provider, signer, contract, userAddress, adminAddress, contractAddress;

    function loadContractAddress() {
      const saved = localStorage.getItem('contractAddress');
      if (saved) {
        document.getElementById('contractAddress').value = saved;
        contractAddress = saved;
        document.getElementById('contractStatus').innerText = '‚úÖ Contract configured';
        document.getElementById('contractStatus').className = 'status connected';
      }
    }

    function saveContractAddress() {
      const address = document.getElementById('contractAddress').value.trim();
      if (!address) {
        updateStatus('contractStatus', '‚ùå Please enter a contract address', 'error');
        return;
      }
      if (!address.startsWith('0x') || address.length !== 42) {
        updateStatus('contractStatus', '‚ùå Invalid address format. Must start with 0x and be 42 characters', 'error');
        return;
      }
      try {
        if (!ethers.utils.isAddress(address)) {
          updateStatus('contractStatus', '‚ùå Invalid Ethereum address', 'error');
          return;
        }
      } catch (e) {
        updateStatus('contractStatus', '‚ùå Invalid Ethereum address', 'error');
        return;
      }
      localStorage.setItem('contractAddress', address);
      contractAddress = address;
      document.getElementById('contractStatus').innerText = '‚úÖ Contract configured';
      document.getElementById('contractStatus').className = 'status connected';

      if (provider && signer) {
        initContract();
      }
    }

    async function initContract() {
      if (!contractAddress) {
        updateStatus('walletStatus', '‚ö†Ô∏è Please configure contract address first', 'warning');
        return false;
      }

      try {
        contract = new ethers.Contract(contractAddress, ABI, signer);
        adminAddress = await contract.admin();

        if (userAddress.toLowerCase() === adminAddress.toLowerCase()) {
          document.getElementById("verifyBtn").style.display = "block";
          updateStatus('walletStatus', `‚úÖ Connected as Admin: ${formatAddress(userAddress)}`, 'connected');
        } else {
          document.getElementById("verifyBtn").style.display = "none";
          updateStatus('walletStatus', `‚úÖ Connected: ${formatAddress(userAddress)}`, 'connected');
        }
        return true;
      } catch (err) {
        console.error('Contract initialization error:', err);
        updateStatus('walletStatus', '‚ùå Error connecting to contract', 'error');
        return false;
      }
    }

    async function connectWallet() {
      try {
        if (typeof window.ethereum === 'undefined') {
          updateStatus('walletStatus', '‚ùå MetaMask not installed. Please install it first.', 'error');
          setTimeout(() => {
            window.open('https://metamask.io/download/', '_blank');
          }, 2000);
          return;
        }

        updateStatus('walletStatus', 'üîÑ Connecting to MetaMask...', 'warning');

        await window.ethereum.request({
          method: 'wallet_requestPermissions',
          params: [{ eth_accounts: {} }]
        });

        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);

        signer = provider.getSigner();
        userAddress = await signer.getAddress();

        if (!userAddress) {
          updateStatus('walletStatus', '‚ùå Failed to get wallet address', 'error');
          return;
        }

        if (contractAddress) {
          await initContract();
        } else {
          updateStatus('walletStatus', `‚úÖ Wallet Connected: ${formatAddress(userAddress)}`, 'connected');
          updateStatus('contractStatus', '‚ö†Ô∏è Please configure contract address', 'warning');
        }

        window.ethereum.removeAllListeners('accountsChanged');
        window.ethereum.removeAllListeners('chainChanged');

        window.ethereum.on('accountsChanged', handleAccountsChanged);
        window.ethereum.on('chainChanged', () => {
          window.location.reload();
        });

      } catch (err) {
        console.error('Wallet connection error:', err);

        if (err.code === 4001) {
          updateStatus('walletStatus', '‚ùå You rejected the connection request', 'error');
        } else if (err.code === -32002) {
          updateStatus('walletStatus', '‚ö†Ô∏è Check MetaMask - connection request pending', 'warning');
        } else if (err.message && err.message.includes('Already processing')) {
          updateStatus('walletStatus', '‚ö†Ô∏è Please check your MetaMask extension', 'warning');
        } else {
          updateStatus('walletStatus', '‚ùå Connection failed. Please try again.', 'error');
        }
      }
    }

    function handleAccountsChanged(accounts) {
      if (accounts.length === 0) {
        updateStatus('walletStatus', '‚ùå Please connect to MetaMask', 'error');
        document.getElementById("verifyBtn").style.display = "none";
      } else {
        window.location.reload();
      }
    }

    async function verifyResume() {
      if (!contract) {
        alert('Please connect your wallet and configure the contract first');
        return;
      }

      try {
        const resumeId = prompt("Enter Resume ID to verify:");
        if (!resumeId) return;

        updateStatus('verificationStatus', '‚è≥ Verifying...', 'warning');

        const tx = await contract.verifyResume(resumeId);
        updateStatus('verificationStatus', '‚è≥ Waiting for confirmation...', 'warning');

        await tx.wait();

        updateStatus('verificationStatus', `‚úÖ Resume ID ${resumeId} Verified Successfully`, 'verified');
      } catch (err) {
        console.error('Verification error:', err);

        if (err.code === 4001) {
          updateStatus('verificationStatus', '‚ùå Transaction rejected by user', 'error');
        } else if (err.message.includes('only admin')) {
          updateStatus('verificationStatus', '‚ùå Only admin can verify resumes', 'error');
        } else {
          updateStatus('verificationStatus', '‚ùå Error: ' + (err.reason || err.message), 'error');
        }
      }
    }

    function updateStatus(elementId, text, className) {
      const element = document.getElementById(elementId);
      element.innerText = text;
      element.className = 'status ' + className;
    }

    function formatAddress(address) {
      return address.slice(0, 6) + '...' + address.slice(-4);
    }

    document.getElementById('saveContractBtn').addEventListener('click', saveContractAddress);
    document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
    document.getElementById('verifyBtn').addEventListener('click', verifyResume);
    document.getElementById('resumeFile').addEventListener('change', function(e) {
      const fileName = e.target.files[0]?.name || 'None';
      document.getElementById('fileName').innerText = fileName;
    });

    loadContractAddress();

    window.addEventListener('load', async () => {
      if (typeof window.ethereum !== 'undefined') {
        try {
          const accounts = await window.ethereum.request({ method: 'eth_accounts' });
          if (accounts.length > 0) {
            connectWallet();
          }
        } catch (err) {
          console.error('Auto-connect check failed:', err);
        }
      }
    });
  </script>
</body>
</html>
